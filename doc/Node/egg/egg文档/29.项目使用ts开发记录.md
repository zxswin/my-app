# 项目使用 ts 开发记录

## sequelize 的安装及配置

- 安装 egg-sequelize 和 mysql2 模块

  > npm install --save egg-sequelize mysql2

- plugin.ts 文件中开启插件

```ts
import { EggPlugin } from 'egg';

const plugin: EggPlugin = {
  sequelize: {
    enable: true,
    package: 'egg-sequelize',
  },
};

export default plugin;
```

- 初始化数据库和 Migrations(迁移)

- 安装 sequelize-cli

  > npm install --save-dev sequelize-cli

- 将所有数据库 Migrations 相关的内容都放在 database 目录下

```js
/* 项目根目录下新建一个 .sequelizerc 配置文件： */
'use strict';

const path = require('path');

module.exports = {
  config: path.join(__dirname, 'database/config.json'),
  'migrations-path': path.join(__dirname, 'database/migrations'),
  'seeders-path': path.join(__dirname, 'database/seeders'),
  'models-path': path.join(__dirname, 'app/model'),
};
```

- 生成 database/config.json 文件和 database/migrations 目录

```bash
# 初始化 Migrations 配置文件和目录
# 会生成 database/config.json 文件和 database/migrations 目录
npx sequelize init:config
npx sequelize init:migrations
```

- 修改 database/config.json 的配置内容

```js
{
  "development": {
    "username": "root",
    "password": "123456",
    "database": "egg_development",
    "host": "127.0.0.1",
    "dialect": "mysql"
  },
  "test": {
    "username": "root",
    "password": "123456",
    "database": "egg_test",
    "host": "127.0.0.1",
    "dialect": "mysql"
  },
  "production": {
    "username": "root",
    "password": "123456",
    "database": "egg_production",
    "host": "127.0.0.1",
    "dialect": "mysql"
  }
}
```

- 生成 migration 文件并创建表

```bash
# 执行完后会在 database/migrations 目录下生成一个 migration 文件(${timestamp}-init-users.js)
npx sequelize migration:generate --name=init-users
```

- migration 文件(\${timestamp}-init-users.js)

```js
'use strict';

module.exports = {
  // 在执行数据库升级时调用的函数，创建 users 表
  up: async (queryInterface, Sequelize) => {
    const { INTEGER, DATE, STRING } = Sequelize;
    await queryInterface.createTable(
      'users',
      {
        id: { type: INTEGER, primaryKey: true, autoIncrement: true },
        name: STRING(30),
        age: INTEGER,
        created_at: DATE,
        updated_at: DATE,
      },
      {
        charset: 'utf8mb4',
        collate: 'utf8mb4_bin',
      },
    );
  },
  // 在执行数据库降级时调用的函数，删除 users 表
  down: async queryInterface => {
    await queryInterface.dropTable('users');
  },
};
```

- 执行 migrate 进行数据库变更

```bash
# 升级数据库
npx sequelize db:migrate
# 如果有问题需要回滚，可以通过 `db:migrate:undo` 回退一个变更
# npx sequelize db:migrate:undo
# 可以通过 `db:migrate:undo:all` 回退到初始状态
# npx sequelize db:migrate:undo:all

# 创建种子文件
npx sequelize seed:generate --name demo-user
# 运行种子文件插入数据
npx sequelize db:seed:all
```

- 编辑种子文件用于初始化数据

```js
'use strict';

module.exports = {
  up: (queryInterface, Sequelize) => {
    return queryInterface.bulkInsert('users', [
      { name: 'John1', age: 2 },
      { name: 'John2', age: 2 },
      { name: 'John3', age: 2 },
      { name: 'John4', age: 2 },
      { name: 'John5', age: 2 },
      { name: 'John6', age: 2 },
    ]);
  },

  down: (queryInterface, Sequelize) => {
    return queryInterface.bulkDelete('users', null, {});
  },
};
```

### app/model/ 目录下编写 Model 文件

- 建议在开发模式下编写 要不然会报类型没找到错误
- model 目录下创建的模型会自动挂载到 ctx.model 下
- app/model/user.ts

```ts
import { Application } from 'egg';

module.exports = (app: Application) => {
  const { STRING, CHAR } = app.Sequelize;
  const Users = app.model.define(
    'users',
    {
      username: {
        type: STRING(20),
        allowNull: false,
      },
      password: {
        type: CHAR(32),
        allowNull: false,
      },
      provider: {
        type: STRING(20),
        allowNull: false,
      },
    },
    {
      charset: 'utf8mb4',
      collate: 'utf8mb4_bin',
    },
  );

  Users.associate = function() {};

  return Users;
};
```

- 会自动生成 typings/app/model/index.d.ts 文件

```ts
// This file is created by egg-ts-helper@1.25.2
// Do not modify this file!!!!!!!!!

import 'egg';
import ExportComments from '../../../app/model/comments';
import ExportContents from '../../../app/model/contents';
import ExportLikes from '../../../app/model/likes';
import ExportUsers from '../../../app/model/users';

declare module 'sequelize' {
  interface Sequelize {
    Comments: ReturnType<typeof ExportComments>;
    Contents: ReturnType<typeof ExportContents>;
    Likes: ReturnType<typeof ExportLikes>;
    Users: ReturnType<typeof ExportUsers>;
  }
}
```

## view 模板插件添加( egg-view-nunjucks )

- 引入 view 插件

  > npm i egg-view-nunjucks --save

- config/plugin.ts 文件中进行配置

```ts
/** 开启 egg-view-nunjucks 插件 */
nunjucks: {
  enable: true,
  package: 'egg-view-nunjucks',
},
```

- 模板文件的根目录，为绝对路径，默认为 \${baseDir}/app/view 可配置

```ts
// config/config.default.ts
const path = require('path');
module.exports = appInfo => {
  const config = {};
  config.view = {
    root: [path.join(appInfo.baseDir, 'app/view'), path.join(appInfo.baseDir, 'path/to/another')].join(','),
  };
  return config;
};
```

- 模板路径缓存，默认开启。
- 指定 .nj 后缀的文件使用 Nunjucks 进行渲染。
- 配置了 defaultExtension 渲染的时候可以省略后缀

```ts
/** 模板文件配置  */
config.view = {
  root: [
    // 模板文件路径
    path.join(appInfo.baseDir, 'app/view'),
  ].join(','),
  defaultViewEngine: 'nunjucks', // 默认模板引擎
  defaultExtension: '.nj', // 渲染的时候可以省略后缀名
  mapping: {
    '.nj': 'nunjucks', // 根据后缀名匹配模板引擎
  },
};

// render app/view/home.nj
await ctx.render('home');
```

- render(name, locals) 渲染模板文件, 并赋值给 ctx.body
- renderView(name, locals) 渲染模板文件, 仅返回不赋值
- renderString(tpl, locals) 渲染模板字符串, 仅返回不赋值

## 静态资源的处理(egg-view-assets) 默认框架已经处理

- 只需要把相关的静态资源放在 public 文件夹下就可以了

## 开启验证插件

- 安装 egg-validate 插件
  > cnpm i -S egg-validate
- 在 config/plugin.ts 文件中配置

```ts
 /** 开启验证插件  */
  validate: {
    enable: true,
    package: 'egg-validate',
  },
```

## 启用安全配置

- config.default.ts 文件中
- 框架中内置了安全插件 egg-security， 提供了默认的安全实践

```ts
/** 中启用 file 模式 用于文件上传等  */
config.multipart = {
  mode: 'stream',
  fileExtensions: ['.apk'], // 增加对 apk 扩展名的文件支持
};

/** jsonp 设置  */
config.jsonp = {
  // csrf: true, // 对 JSONP 接口开启 CSRF 校验。
  callback: 'callback', // 识别 query 中的 `callback` 参数
  limit: 100, // 函数名最长为 100 个字符
  // whiteList: /^https?:\/\/test.com\//, // 设置请求白名单
  // whiteList: '.test.com', // 包括了test.com 的所有子域名，包括 test.com 自身
  // whiteList: 'sub.test.com', // sub.test.com 这一个域名。（同时支持 HTTP 和 HTTPS）
  // whiteList: [ 'sub.test.com', 'sub2.test.com' ],
};

/** 设置重定向安全的白名单  */
config.security = {
  csrf: {
    enable: true, // 开启CSRF防护
    ignore: ctx => ctx.ip === '127.0.0.1', // 不对这个ip地址的cors跨域请求进行csrf校验
  },
  // domainWhiteList: ['.domain.com'] // 安全白名单，以 . 开头
  // domainWhiteList: ['http://127.0.0.1'],
  // domainWhiteList: ['http://localhost'],
};
```

## 启用 CORS 处理跨域插件

- 安装 egg-cors 插件

  > cnpm i -S egg-cors

- 在 config/plugin.ts 文件中配置

```ts
 /** 开启验证插件  */
cors: {
    enable: true,
    package: 'egg-cors',
  },
```

- config/config.default.ts 文件中

```ts
/** CORS跨域配置  */
config.cors = {
  origin: '*',
  allowMethods: 'GET,HEAD,PUT,POST,DELETE,PATCH',
};
```

## 开启 Passport 登录鉴权

- 安装 egg-passport 插件

  > cnpm i -S egg-passport

- 在 config/plugin.ts 文件中配置

```ts
/** 开启Passport登录鉴权  */
passport: {
  enable: true,
  package: 'egg-passport',
},
passportWeibo: {
  enable: true,
  package: 'egg-passport-weibo',
},

passportTwitter: {
  enable: true,
  package: 'egg-passport-twitter',
},

passportGithub: {
  enable: true,
  package: 'egg-passport-github',
},

passportBitbucket: {
  enable: true,
  package: 'egg-passport-bitbucket',
},
```

- config/config.default.ts 文件中

```ts
config.passportWeibo = {
  key: 'a',
  secret: 'b',
};

config.passportGithub = {
  key: 'b7a9c170da074ce5e43f',
  secret: '65699d679cc5ec8d7bfb980e711b93219a860fd8',
};

config.passportBitbucket = {
  key: 'e',
  secret: 'f',
};

config.passportTwitter = {
  key: 'g',
  secret: 'h',
};
```
