# 09.CORS 实现跨域请求

## 知识要点

```bash
Cross-Origin Resource Sharing（CORS）跨来源资源共享是一份浏览器技术的规范，提供了 Web 服务从不同域传来沙盒脚本的方法，以避开浏览器的同源策略，是 JSONP 模式的现代版。
如果浏览器支持HTML5，那么就可以一劳永逸地使用新的跨域策略：CORS了。
首先检查Access-Control-Allow-Origin是否包含本域，如果是，则此次跨域请求成功，如果不是，则请求失败
跨域能否成功，取决于对方服务器是否愿意给你设置一个正确的Access-Control-Allow-Origin，决定权始终在对方手中
简单请求包括GET、HEAD和POST（POST的Content-Type类型
仅限application/x-www-form-urlencoded、multipart/form-data和text/plain）
除了JavaScript和CSS外，都要验证CORS。例如，当你引用了某个第三方CDN上的字体文件时：
PUT、DELETE以及其他类型如application/json的POST请求，在发送AJAX请求之前，浏览器会先发送一个OPTIONS请求（称为preflighted请求）
OPTIONS /path/to/resource HTTP/1.1
Host: bar.com
Origin: http://my.com
Access-Control-Request-Method: POST
177.服务器必须响应并明确指出允许的Method：
HTTP/1.1 200 OK
Access-Control-Allow-Origin: http://my.com
Access-Control-Allow-Methods: POST, GET, PUT, OPTIONS
Access-Control-Max-Age: 86400
```

## 简单例子

- js 后端服务文件
  Access-Control-Allow-Origin:指定授权访问的域
  Access-Control-Allow-Methods：授权请求的方法（GET, POST, PUT, DELETE，OPTIONS 等)
  Access-Control-Allow-Origin 只能配置 或者一个域名\*

```js
const Controller = require('egg').Controller;

class CorsController extends Controller {
  async list() {
    const ctx = this.ctx;
    /** 实现CORS跨域响应头  */
    ctx.set({
      'Access-Control-Allow-Origin': 'http://127.0.0.1',
      'Access-Control-Allow-Methods': 'POST',
      'Access-Control-Max-Age': '86400'
    });
    ctx.body = {
      name: 'eggcors',
      category: 'framework',
      language: 'cors'
    };
  }
}

module.exports = CorsController;
```

- 前端请求文件

```html
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>cors 实现跨域请求</title>
    <link rel="stylesheet" href="" />
    <script src="../public/js/jquery-3.3.1.js"></script>
  </head>

  <body>
    <button id="btn">cors 实现跨域请求</button>
  </body>

  <script>
    $(function() {
      $('#btn').on('click', function() {
        console.log('cors 实现跨域请求 执行跨域请求');

        // cors 实现跨域请求
        $.ajax({
          url: `http://127.0.0.1:7001/api/cors`,
          type: 'post',
          dataType: 'json', //数据类型为jsonp
          success: function(data) {
            console.log('cors 实现跨域请求', data);
          },
          error: function() {
            console.log('cors 实现跨域请求 失败');
          }
        });
      });
    });
  </script>
</html>
```

## 通过 egg-cors 插件实现

```js
// 步骤一：下载 egg-cors 包
cnpm i egg-cors --save

// 步骤二：plugin.js中设置开启cors
exports.cors = {
	enable: true,
	package: 'egg-cors',
};

// 步骤三：config.default.js中配置，注意配置覆盖的问题
config.security = {
	// 关闭csrf
	csrf: {
		enable: false,
		ignoreJSON: true
	},
	domainWhiteList: '*'
};

// 允许跨域
config.cors = {
	origin:'*',
	allowMethods: 'GET,HEAD,PUT,POST,DELETE,PATCH'
};

```
