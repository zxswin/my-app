# 使用 TypeScript 编写项目

## egg-cli 脚手架构建框架(项目搭建方法一)

```bash
# 全局安装egg-init
$ npm i egg-init -g
# 会在当前目录下生成egg-cli文件加并生成相关文件
$ egg-init egg-cli --type=ts
# 定位到egg-cli目录下并安装相关依赖包
$ cd egg-cli
$ npm i

# 启动项目:
$ npm run dev
$ open localhost:7001
```

## egg-cli Ts 使用

- 部署到生产环境上 使用 npm run start 启动服务，跑的是 egg-scripts 命令
  运行 npm start 不会加载 ts 执行之前要先把 js 文件编译出来 不然报错
  使用 egg-bin 的时候才允许直接运行 ts

```bash
# 启动服务
npm run start
# 关闭服务
npm run stop
# 启动测试开发环境
npm run dev
# 编译js文件(在ts对应目录里再生成一份同名的js文件,会执行[egg-ts-helper]插件去生成对应的.d.ts声明文件)
npm run ci
# 清除js文件
npm run clean
```

### 代码编写

- 控制器（Controller）

```ts
// app/controller/home.ts
import { Controller } from 'egg';

export default class HomeController extends Controller {
  public async index() {
    const { ctx, service } = this;
    const page = ctx.query.page;
    const result = await service.news.list(page);
    await ctx.render('home.tpl', result);
  }
}
```

- 路由（Router）

```ts
// app/router.ts
import { Application } from 'egg';

export default (app: Application) => {
  const { router, controller } = app;
  router.get('/', controller.home.index);
};
```

- 服务（Service）

```ts
// app/service/news.ts
import { Service } from 'egg';

export default class NewsService extends Service {
  public async list(page?: number): Promise<NewsItem[]> {
    return [];
  }
}

export interface NewsItem {
  id: number;
  title: string;
}
```

- 中间件（Middleware）

```js
// Middleware 目前返回值必须都是 any 不然编译会报错
import { Context } from 'egg';

// 这里是你自定义的中间件
export default function fooMiddleware(): any {
  return async (ctx: Context, next: () => Promise<any>) => {
    // 你可以获取 config 的配置：
    // const config = ctx.app.config;
    // config.xxx....
    await next();
  };
}
```

- 扩展（Extend）

```js
// app/extend/context.ts
import { Context } from 'egg';

export default {
  isAjax(this: Context) {
    return this.get('X-Requested-With') === 'XMLHttpRequest';
  },
}

// app.ts
export default app => {
  app.beforeStart(async () => {
    await Promise.resolve('egg + ts');
  });
};
```

- 配置（Config）

```ts
// app/config/config.default.ts
import { EggAppInfo, EggAppConfig, PowerPartial } from 'egg';

export default (appInfo: EggAppInfo) => {
  const config = {} as PowerPartial<EggAppConfig>;

  // 覆盖框架，插件的配置
  config.keys = appInfo.name + '123456';
  config.view = {
    defaultViewEngine: 'nunjucks',
    mapping: {
      '.tpl': 'nunjucks'
    }
  };

  // 应用本身的配置
  const bizConfig = {};
  bizConfig.news = {
    pageSize: 30,
    serverUrl: 'https://hacker-news.firebaseio.com/v0'
  };

  // 目的是将业务配置属性合并到 EggAppConfig 中返回
  return {
    // 如果直接返回 config ，将该类型合并到 EggAppConfig 的时候可能会出现 circulate type 错误。
    ...(config as {}),
    ...bizConfig
  };
};
```

- 插件（Plugin）

```ts
// config/plugin.ts
import { EggPlugin } from 'egg';

const plugin: EggPlugin = {
  static: true,
  nunjucks: {
    enable: true,
    package: 'egg-view-nunjucks'
  }
};

export default plugin;
```

- 生命周期（Lifecycle）

```ts
// app.ts
import { Application, IBoot } from 'egg';

export default class FooBoot implements IBoot {
  private readonly app: Application;

  constructor(app: Application) {
    this.app = app;
  }

  configWillLoad() {
    // Ready to call configDidLoad,
    // Config, plugin files are referred,
    // this is the last chance to modify the config.
  }

  configDidLoad() {
    // Config, plugin files have loaded.
  }

  async didLoad() {
    // All files have loaded, start plugin here.
  }

  async willReady() {
    // All plugins have started, can do some thing before app ready.
  }

  async didReady() {
    // Worker is ready, can do some things
    // don't need to block the app boot.
  }

  async serverDidReady() {
    // Server is listening.
  }

  async beforeClose() {
    // Do some thing before app close.
  }
}
```
