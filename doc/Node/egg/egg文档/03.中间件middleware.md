# 中间件（Middleware）

## 使用 Koa 的中间件

- 用法示例

```js
/** 安装 koa-compress 插件
 * cnpm i -S koa-compress
 * 中间件的作用是对接口返回的内容进行gzip压缩 (js ,html ,css等静态资源)
 * Content-Encoding: gzip
 */

/** koa-compress 暴露的接口(`(options) => middleware`)和框架对中间件要求一致  */
// app/middleware/compress.js
module.exports = require('koa-compress');

/** 配置 koa-compress 中间件  */
// config/config.default.js
config.middleware = ['compress'];
config.compress = {
  threshold: 2048
};
```

- 通用配置项

```bash
# enable：控制中间件是否开启。
enable: false,
# match：设置只有符合某些规则的请求才会经过这个中间件。
match: '/static',
match(ctx) {
  // 只有 ios 设备才开启
  const reg = /iphone|ipad|ipod/i;
  return reg.test(ctx.get('user-agent'));
  },
# ignore：设置符合某些规则的请求不经过这个中间件。
ignore: '/static',
```

## router 中使用中间件

```js
/** 无需在 config/config.default.js中配置  */
// app/router.js
const compress = app.middleware.compress({ threshold: 1 });
router.get('/api/resimg', compress, controller.contents.resimg);
```

## 自定义中间件写法

- 中间件 js 代码

```js
// app/middleware/gzip.js
const isJSON = require('koa-is-json');
const zlib = require('zlib');

module.exports = options => {
  return async function gzip(ctx, next) {
    await next();

    // 后续中间件执行完成后将响应体转换成 gzip
    let body = ctx.body;
    if (!body) return;

    // 支持 options.threshold
    if (options.threshold && ctx.length < options.threshold) return;

    if (isJSON(body)) body = JSON.stringify(body);

    // 设置 gzip body，修正响应头
    const stream = zlib.createGzip();
    stream.end(body);
    ctx.body = stream;
    ctx.set('Content-Encoding', 'gzip');
  };
};
```

- 中间件配置

```js
/** 在应用中使用中间件
 * 配置 koa-compress 中间件
 */
config.middleware = ['gzip'];
// 作为options 的参数 app.config[${middlewareName}]
config.gzip = {
  threshold: 1,
  enable: false // 通用配置项 是否开启
};
```
