## 表结构设计

- 用户表结构设计

users 用户基本信息表 => 关联 roles 角色表 (1 个用户有一个角色)
roles 角色表 => 关联 permissions 用户权限表 (1 个角色有多个权限)

```bash
## users 用户基本信息表
id                   用户id
username	           用户名
password	           密码
last_login_time 	   上次登录时间
last_login_ip	       上次登录IP
email	               邮箱
created_at	         创建时间
updated_at           更新时间
status               状态
role_id	             对应角色ID

## roles 角色表设计
id                   角色id
name                 角色名称
description          角色描述
created_at	         创建时间
updated_at           更新时间

## permissions 用户权限表
id                   权限id
name                 权限名称
type                 权限类型
value                权限值
status               权限状态
created_at	         创建时间
updated_at           更新时间


## oplogs操作日志表
id                   日志id
description          操作描述
username             操作用户
created_at	         创建时间
updated_at           更新时间
url                  请求的url
method               请求类型
ip                   ip地址
permissions          权限值

```

- sequelize 进行表关联及强制创建数据表 表关联会自动创建外键

```ts
// 一对一关联
Users.associate = () => {
  // 一个用户对应一个角色
  app.model.Users.belongsTo(app.model.Roles);
};

// 一对多关联
Roles.associate = () => {
  // 一个角色对应多个权限
  app.model.Roles.hasMany(app.model.Permissions);
};

// 多对多关联
/** 会新建一个UserProject的表 并添加 compaId 和 userId字段  */
Comp.belongsToMany(User, { through: 'UserProject' });
```

- 强制创建表

```ts
import { Controller } from 'egg';

export default class HomeController extends Controller {
  public async index() {
    const { ctx, app } = this;
    // 强制创建数据表
    await app.model.sync({ force: true });
    await ctx.render('home', { a: 1, b: 2 });
  }
}
```

- 菜单表结构设计

```bash
## 产品菜单表结构
id                 菜单id
name               菜单名称
order              菜单排列顺序
icon_url           菜单图标地址
type               菜单类型
describe           菜单描述
status             菜单状态

```

- 产品表结构设计

```bash
id                 产品id
name               产品名称
icon_url           产品图标
price              产品价格
stock              产品库存
sales_volume       产品销量
type               产品类型
order              产品排列顺序
status             产品状态
describe           产品描述
standard           产品标准规格
slide_imgs         幻灯片图片集
content            产品内容
video_url          产品视频



```

## 数据库的备份与还原

```bash
# 备份操作
## 1.navicat for mysql 工具中选中要备份的数据库
## 2.选中备份选项 - 执行生成备份文件操作
## 3.选中生成的备份文件 - 执行提取sql从……的操作
## 4.在本地中会生成一个sql文件

# 还原操作
## 1.新建数据库和之前的名字一样
## 2.执行运行sql文件命令
## 3.完成还原操作
```

## sequelize 操作数据库

- 常用的查询

```ts
/**
 * 关联关系的嵌套查询
 */

// 与Users一对一的关系表
const Roles = this.ctx.model.Roles;
// 与Roles一对多的关系表
const Permissions = this.ctx.model.Permissions;

return this.ctx.model.Users.findAndCountAll({
  offset,
  limit,
  order: [['id', 'asc']],
  where: whereParam,
  include: [
    {
      model: Roles,
      include: [{ model: Permissions }],
    },
  ],
});
```

## 请求参数的获取

```ts
// 获取查询参数
const params = ctx.query as UserPagingQuery;

// 获取body参数
const params = ctx.request.body as UserLogin;

// 返回数据给客户端
ctx.body = await ctx.service.user.list(params);
```

## Cookie 与 Session 的使用

- 设置和获取 cookie

```ts
// cookies的值必须设置为字符串类型
ctx.cookies.set('userid', String(rows[0].id), {
  httpOnly: true, // 默认就是 true
  signed: true,
  encrypt: true, // 加密传输
});

// 获取的参数要和设置的参数保持一致 要不然会获取不到
const userid = ctx.cookies.get('userid', {
  signed: true,
  encrypt: true, // 加密传输
});
```

- 设置和获取 Session

```ts
// 设置session
ctx.session.userid = userid;

// 获取session
console.log('ctx.session.userid======', ctx.session.userid);
```

## 接口请求

```ts
```

## 文件上传

```ts
```

## 加密与解密

```ts
```

## 启用安全威胁 CSRF 的防范后的相关问题

```js
// - 在 CSRF 默认配置下，token 会被设置在 Cookie 中，在 AJAX 请求的时候，
// - 可以从 Cookie 中取到 token，放置到 query、body 或者 header 中发送给服务端。
// 执行post相关请求
function sendPost() {
  console.log('发送post请求');
  $.post(
    'http://127.0.0.1:7001/users/add',
    {
      name: '小龙',
      age: 21,
    },
    function (result) {
      console.log('接口返回的结果数据', result);
    }
  );
}
$(function () {
  let csrftoken = getcookie('csrfToken');
  console.log('csrftoken', csrftoken);

  // 获取指定名称的cookie的值
  function getcookie(objname) {
    var arrstr = document.cookie.split('; ');
    for (var i = 0; i < arrstr.length; i++) {
      var temp = arrstr[i].split('=');
      if (temp[0] === objname) return unescape(temp[1]);
    }
  }

  // 发送前设置请求头
  function csrfSafeMethod(method) {
    // webpack搭建的开发环境中经测试get和post请求都会启用安全威胁 CSRF
    return /^(HEAD|OPTIONS|TRACE)$/.test(method);
  }
  $.ajaxSetup({
    beforeSend: function (xhr, settings) {
      console.log('this', this);
      console.log('settings.type', settings.type); // POST
      console.log('this.crossDomain', this.crossDomain); // false 是否跨域
      if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
        /** 关键代码 设置请求头  */
        xhr.setRequestHeader('x-csrf-token', csrftoken);
      }
    },
  });
});
```

## 与 webpack 配合

- webpack.config.js 配置文件设置代理

```ts
devServer: {
    contentBase: './dist',
    hot: true,
    // 代理到后端服务接口
    proxy: {
      // '/api': 'http://localhost:7001/',
      '/api': {
        target: 'http://localhost:7001',
        // 比如访问的API路径：/ api / users,
        // 设置pathRewrite: { '^/api': '' }, 后，
        // 最终代理访问的路径：http://www.baidu.com/users，
        pathRewrite: { '^/api': '' },
        changeOrigin: true, // target是域名的话，需要这个参数，
        secure: false, // 设置支持https协议的代理
      },
    },
  },
```
