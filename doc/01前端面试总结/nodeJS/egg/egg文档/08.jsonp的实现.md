# 08.jsonp 的实现

## Egg.js 实现 JSONP 的简单案例

- 通过 app.jsonp() 提供的中间件来让一个 controller 支持响应 JSONP 格式的数据

```js
// app/router.js
module.exports = app => {
  const jsonp = app.jsonp();
  app.router.get('/api/posts/:id', jsonp, app.controller.posts.show);
  app.router.get('/api/posts', jsonp, app.controller.posts.list);
};
```

- 在 Controller 中，只需要正常编写即可：

```js
const Controller = require('egg').Controller;

class JsonpController extends Controller {
  async list() {
    const ctx = this.ctx;
    ctx.body = {
      name: 'egg',
      category: 'framework',
      language: 'Node.js'
    };
  }
}

module.exports = JsonpController;
```

- 前端中的请求代码

```html
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>jsonp 实现跨域请求</title>
    <link rel="stylesheet" href="" />
    <script src="../public/js/jquery-3.3.1.js"></script>
  </head>

  <body>
    <button id="btn">使用jsonp跨域请求资源(普通方式)</button>
    <button id="btn1">使用jquery ajax 执行jsonp跨域请求资源</button>
  </body>

  <script>
    function getList() {
      var js = document.createElement('script'),
        head = document.getElementsByTagName('head')[0];
      js.src = 'http://127.0.0.1:7001/api/jsonp?callback=list';
      head.appendChild(js);
    }

    function list(data) {
      console.log('通过jsonp获取到了数据', data);
    }

    $(function() {
      $('#btn').on('click', function() {
        console.log('点击执行jsonp跨域请求');
        getList();
      });

      $('#btn1').on('click', function() {
        console.log('点击jquery执行jsonp跨域请求');

        // jsonp跨域请求
        $.ajax({
          url: `http://127.0.0.1:7001/api/jsonp`,
          type: 'get',
          dataType: 'jsonp', //数据类型为jsonp
          jsonp: 'callback', //服务端用于接收callback调用的function名的参数
          success: function(data) {
            console.log('通过jquery 实现jsonp数据获取', data);
          },
          error: function() {
            console.log('通过jquery 实现jsonp数据获取 失败');
          }
        });
      });
    });
  </script>
</html>
```

## jsonp 相关配置

- 当 CSRF 和 referrer 校验同时开启时，请求发起方只需要满足任意一个条件即可通过 JSONP 的安全校验。

```js
/** jsonp 设置  */
exports.jsonp = {
  // jsonp 必须只能是GET请求
  // csrf: true, // 对 JSONP 接口开启 CSRF 校验。
  // 在开启 CSRF 校验时，客户端在发起 JSONP 请求时，也要带上 CSRF token
  // 请求示例 url: `api/upload?_csrf={{ ctx.csrf | safe }}`,
  callback: 'callback', // 识别 query 中的 `callback` 参数
  limit: 100 // 函数名最长为 100 个字符
  // whiteList: /^https?:\/\/test.com\//, // 设置请求白名单
  // whiteList: '.test.com', // 包括了test.com 的所有子域名，包括 test.com 自身
  // whiteList: 'sub.test.com', // sub.test.com 这一个域名。（同时支持 HTTP 和 HTTPS）
  // whiteList: [ 'sub.test.com', 'sub2.test.com' ],
};
```
