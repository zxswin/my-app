# Passport 登录鉴权第三方登录

## egg-passport 插件

- 把初始化、鉴权成功后的回调处理等通用逻辑封装掉
- 开发者仅需调用几个 API 即可方便的使用 Passport

## Passport 的执行时序如下：

```bash
用户访问页面
检查 Session
拦截跳鉴权登录页面
Strategy 鉴权
校验和存储用户信息
序列化用户信息到 Session
跳转到指定页面
```

## 使用 egg-passport

### 安装

```js
$ npm i --save egg-passport
$ npm i --save egg-passport-github
```

### 开启插件：

```js
// config/plugin.js
module.exports.passport = {
  enable: true,
  package: 'egg-passport'
};

module.exports.passportGithub = {
  enable: true,
  package: 'egg-passport-github'
};
```

### 配置

- egg-passport 标准化了配置字段，统一为 key 和 secret

```js
// config/default.js
config.passportGithub = {
  key: 'your_clientID',
  secret: 'your_clientSecret'
  // callbackURL: '/passport/github/callback',
  // proxy: false,
};
```

### 挂载路由

```js
// app/router.js
module.exports = app => {
  const { router, controller } = app;

  // 挂载鉴权路由
  app.passport.mount('github');

  // 上面的 mount 是语法糖，等价于
  // const github = app.passport.authenticate('github', {});
  // router.get('/passport/github', github);
  // router.get('/passport/github/callback', github);
};
```

### 用户信息处理

- 首次登录时，一般需要把用户信息进行入库，并记录 Session 。
- 二次登录时，从 OAuth 或 Session 拿到的用户信息，读取数据库拿到完整的用户信息。

```js
// app.js
module.exports = app => {
  app.passport.verify(async (ctx, user) => {
    // 检查用户
    assert(user.provider, 'user.provider should exists');
    assert(user.id, 'user.id should exists');

    // 从数据库中查找用户信息
    //
    // Authorization Table
    // column   | desc
    // ---      | --
    // provider | provider name, like github, twitter, facebook, weibo and so on
    // uid      | provider unique id
    // user_id  | current application user id
    const auth = await ctx.model.Authorization.findOne({
      uid: user.id,
      provider: user.provider
    });
    const existsUser = await ctx.model.User.findOne({ id: auth.user_id });
    if (existsUser) {
      return existsUser;
    }
    // 调用 service 注册新用户
    const newUser = await ctx.service.user.register(user);
    return newUser;
  });

  // 将用户信息序列化后存进 session 里面，一般需要精简，只保存个别字段
  app.passport.serializeUser(async (ctx, user) => {
    // 处理 user
    // ...
    // return user;
  });

  // 反序列化后把用户信息从 session 中取出来，反查数据库拿到完整信息
  app.passport.deserializeUser(async (ctx, user) => {
    // 处理 user
    // ...
    // return user;
  });
};
```

### egg-passport 提供了以下扩展：

```bash
ctx.user - 获取当前已登录的用户信息
ctx.isAuthenticated() - 检查该请求是否已授权
ctx.login(user, [options]) - 为用户启动一个登录的 session
ctx.logout() - 退出，将用户信息从 session 中清除
ctx.session.returnTo= - 在跳转验证前设置，可以指定成功后的 redirect 地址
```

### egg-passport API：

- app.passport.authenticate 中，未设置 options.successRedirect 或者 options.successReturnToOrRedirect 将默认跳转 /

```bash
app.passport.verify(async (ctx, user) => {}) - 校验用户
app.passport.serializeUser(async (ctx, user) => {}) - 序列化用户信息后存储进 session
app.passport.deserializeUser(async (ctx, user) => {}) - 反序列化后取出用户信息
app.passport.authenticate(strategy, options) - 生成指定的鉴权中间件
  options.successRedirect - 指定鉴权成功后的 redirect 地址
  options.loginURL - 跳转登录地址，默认为 /passport/${strategy}
  options.callbackURL - 授权后回调地址，默认为 /passport/${strategy}/callback
app.passport.mount(strategy, options) - 语法糖，方便开发者配置路由
```

### 简单的使用案例

- 先要在 github 等网站新建一个授权登录用例

- 在 config.default.js 文件中进行秘钥配置

```js
 config.passportWeibo = {
    key: 'a',
    secret: 'b',
  };

  config.passportGithub = {
    key: 'b',
    secret: '6',
  };

  config.passportBitbucket = {
    key: 'e',
    secret: 'f',
  };

  config.passportTwitter = {
    key: 'g',
    secret: 'h',
  };

  return config;
};

```

- 在 plugin.js 文件中启动授权插件

```js
/** 开启Passport登录鉴权  */
exports.passport = {
  enable: true,
  package: 'egg-passport'
};

exports.passportWeibo = {
  enable: true,
  package: 'egg-passport-weibo'
};

exports.passportTwitter = {
  enable: true,
  package: 'egg-passport-twitter'
};

exports.passportGithub = {
  enable: true,
  package: 'egg-passport-github'
};

exports.passportBitbucket = {
  enable: true,
  package: 'egg-passport-bitbucket'
};
```

- router.js 中挂载权限路由

```js
/** 挂载鉴权路由  */

/** 这个路由是可以不用的在第三方授权运用配置页面指定好跳转地址就可以了  */
app.router.get('/passport', controller.example.passport.render);

app.passport.mount('weibo');
app.passport.mount('github');
app.passport.mount('bitbucket');
app.passport.mount('twitter');
```

- passport 接口中实现相关路由的配置逻辑

```js
const Controller = require('egg').Controller;
const md5 = require('md5');

class PassportController extends Controller {
  async render() {
    const ctx = this.ctx;

    console.log(
      'ctx.isAuthenticated()============================',
      ctx.isAuthenticated()
    );

    if (ctx.isAuthenticated()) {
      // 当前用户已经授权登录了
      console.log('当前用户已经授权登录了11111111111111111111');
      // ctx.body = `<div>
      //   <h2>${ctx.path}</h2>
      //   <hr>
      //   Logined user: <img src="${ctx.user.photo}"> ${ctx.user.displayName} / ${
      //   ctx.user.id
      // } | <a href="/api/loginout">Logout</a>
      //   <pre><code>${JSON.stringify(ctx.user, null, 2)}</code></pre>
      //   <hr>
      //   <a href="/">Home</a> | <a href="/user">User</a>
      // </div>`;

      console.log('ctx.user', JSON.stringify(ctx.user, null, 2));
      let username = ctx.user.name;
      let password = ctx.user.id;
      let provider = ctx.user.provider;

      /** 用户是否已经被注册过了  */
      let user = await this.ctx.model.Users.findOne({
        where: {
          username
        }
      });

      if (!user) {
        user = await ctx.model.Users.build({
          username,
          password: md5(password),
          provider: provider
        }).save();
      }

      // 设置cookies
      ctx.cookies.set('username', user.get('username'), {
        httpOnly: true, // 默认就是 true
        signed: true, // 加签传输
        encrypt: true // 加密传输
      });

      // 设置session
      ctx.session.uid = user.get('id');

      ctx.rotateCsrfSecret(); // 更新csrfToken

      console.log('准备跳转');
      // ctx.session.returnTo = '/';
      ctx.redirect('/');
    } else {
      // ctx.session.returnTo = '/login';
      // 当前用户没有授权登录 可以删除 因为如果没有授权登录是不会跑到这里的
      console.log('当前用户没有授权登录111111111111111111111');
      ctx.session.returnTo = ctx.path;
      ctx.body = `
        <div>
          <h2>${ctx.path}</h2>
          <hr>
          Login with
          <a href="/passport/weibo">Weibo</a> | <a href="/passport/github">Github</a> |
          <a href="/passport/bitbucket">Bitbucket</a> | <a href="/passport/twitter">Twitter</a>
          <hr>
          <a href="/">Home</a> | <a href="/user">User</a>
        </div>
      `;
    }
  }
}

module.exports = PassportController;
```
