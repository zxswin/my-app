# 文件上传

## 文件上传代码示例

- 前端代码

```html
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>fileApi实现Ajax上传文件</title>
    <link rel="stylesheet" href="" />
    <script src="../public/js/jquery-3.3.1.js"></script>
    <script>
      $(function() {
        console.log(`csrf {{ ctx.csrf | safe }}`);

        var formData = null;

        $('#file').on('change', function() {
          var fd = new FormData(); //创建FormData对象
          fd.append('name', '图片类型');
          fd.append('title', '文件上传');
          $('#debug').html('');
          var files = document.getElementsByTagName('input')[0].files; //js读取上传文件
          for (var i = 0; i < files.length; i++) {
            fd.append('files' + i, files[i]); //添加文件数据
            var img = document.createElement('img'); //动态创建img标签
            img.src = window.URL.createObjectURL(files[i]); //把二进制对象直接读出浏览器显示的资源
            var con = '<p>';
            con +=
              '文件名：' + files[i].name + '大小：' + files[i].size + '<br/>';
            con += '</p>';
            $('#debug').append(con);
            $('#debug').append(img);
          }

          formData = fd;
        });

        $('#btn').on('click', function() {
          console.log('点击上传');

          //ajax上传文件
          $.ajax({
            url: `api/upload?_csrf={{ ctx.csrf | safe }}`,
            type: 'POST',
            cache: false,
            data: formData,
            processData: false,
            contentType: false,
            dataType: 'json',
            beforeSend: function() {},
            success: function(data) {}
          });
        });
      });
    </script>
  </head>

  <body>
    <input id="file" type="file" name="pic" multiple="multiple" />
    <button id="btn">点击上传文件 {{name}}</button>
    <div id="debug"></div>
  </body>
</html>
```

- 后端代码

```js
const fs = require('fs');
const path = require('path');
const Controller = require('egg').Controller;
// const pump = require('pump'); // 文件流管道生成文件
const uuidv1 = require('uuid/v1'); // 用于生成唯一值

class UploaderController extends Controller {
  async upload() {
    const ctx = this.ctx;

    const parts = this.ctx.multipart({ autoFields: true });
    const files = [];

    let stream;
    while ((stream = await parts()) != null) {
      const filename = stream.filename.toLowerCase();

      let dataObj = new Date();
      let month = Number.parseInt(dataObj.getMonth(), 0) + 1;
      let date = Number.parseInt(dataObj.getDate(), 0);
      month = month.toString().length > 1 ? month : `0${month}`;
      date = date.toString().length > 1 ? date : `0${date}`;

      let fileDir = `${dataObj.getFullYear()}${month}${date}`;
      let dir = path.join(__dirname, `../public/uploads/${fileDir}/`);

      /**
       * 按照日期生成文件目录
       */

      try {
        fs.accessSync(dir);
      } catch (err) {
        console.log('err===================', err);
        fs.mkdirSync(dir);
      }

      const target = dir + uuidv1().substring(0, 9) + filename;
      const writeStream = fs.createWriteStream(target);
      /** 利用数据流通过管道生成文件  */
      // await pump(stream, writeStream);
      await stream.pipe(writeStream);
      console.log('文件上传成功888', target);
      files.push(filename);
    }

    ctx.body = {
      info: '上传成功',
      files: files,
      /** 附带上传的字段  */
      body: Object.keys(parts.field).map(key => ({
        key,
        value: parts.field[key]
      }))
    };
  }
}

module.exports = UploaderController;
```
