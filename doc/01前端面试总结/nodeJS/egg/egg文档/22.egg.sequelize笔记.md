# 基于 egg 的后端系统构建(sequelize 模式)

## 逐步搭建(项目搭建方法)

- 项目初始化及依赖安装

```bash
# 初始化项目
$ npm init
# 依赖安装
$ npm i egg --save
$ npm i egg-bin --save-dev

```

## 新建必要目录

```bash
# app 目录
# config目录
```

## 启动项目

```bash
# 项目启动后会自动生成 run目录 和 logs目录
npm run dev
```

## egg 项目中使用 sequelize

```bash
# 安装 egg-sequelize 和 mysql2 模块
npm install --save egg-sequelize mysql2
```

### 在 config/plugin.js 中引入 egg-sequelize 插件

```js
exports.sequelize = {
  enable: true,
  package: 'egg-sequelize',
};
```

### config/config.default.js 中编写 sequelize 配置

```js
/** sequelize 的相关配置  */
config.sequelize = {
  username: 'root',
  password: '123456',
  database: 'egg_development',
  host: '127.0.0.1',
  port: 3306,
  dialect: 'mysql',
  timezone: '+08:00',
};
```

### 初始化数据库和 Migrations(迁移)

```bash
# 安装 sequelize-cli
npm install --save-dev sequelize-cli
```

#### 将所有数据库 Migrations 相关的内容都放在 database 目录下

```js
/* 项目根目录下新建一个 .sequelizerc 配置文件： */
'use strict';

const path = require('path');

module.exports = {
  config: path.join(__dirname, 'database/config.json'),
  'migrations-path': path.join(__dirname, 'database/migrations'),
  'seeders-path': path.join(__dirname, 'database/seeders'),
  'models-path': path.join(__dirname, 'app/model'),
};
```

- 生成 database/config.json 文件和 database/migrations 目录

```bash
# 初始化 Migrations 配置文件和目录
# 会生成 database/config.json 文件和 database/migrations 目录
npx sequelize init:config
npx sequelize init:migrations
```

- 修改 database/config.json 的配置内容

```js
{
  "development": {
    "username": "root",
    "password": "123456",
    "database": "egg_development",
    "host": "127.0.0.1",
    "dialect": "mysql"
  },
  "test": {
    "username": "root",
    "password": "123456",
    "database": "egg_test",
    "host": "127.0.0.1",
    "dialect": "mysql"
  },
  "production": {
    "username": "root",
    "password": "123456",
    "database": "egg_production",
    "host": "127.0.0.1",
    "dialect": "mysql"
  }
}
```

- 生成 migration 文件并创建表

```bash
# 执行完后会在 database/migrations 目录下生成一个 migration 文件(${timestamp}-init-users.js)
npx sequelize migration:generate --name=init-users
```

- migration 文件(\${timestamp}-init-users.js)

```js
'use strict';

module.exports = {
  // 在执行数据库升级时调用的函数，创建 users 表
  up: async (queryInterface, Sequelize) => {
    const { INTEGER, DATE, STRING } = Sequelize;
    await queryInterface.createTable(
      'users',
      {
        id: { type: INTEGER, primaryKey: true, autoIncrement: true },
        name: STRING(30),
        age: INTEGER,
        created_at: DATE,
        updated_at: DATE,
      },
      {
        charset: 'utf8mb4',
        collate: 'utf8mb4_bin',
      },
    );
  },
  // 在执行数据库降级时调用的函数，删除 users 表
  down: async queryInterface => {
    await queryInterface.dropTable('users');
  },
};
```

- 执行 migrate 进行数据库变更

```bash
# 升级数据库
npx sequelize db:migrate
# 如果有问题需要回滚，可以通过 `db:migrate:undo` 回退一个变更
# npx sequelize db:migrate:undo
# 可以通过 `db:migrate:undo:all` 回退到初始状态
# npx sequelize db:migrate:undo:all

# 创建种子文件
npx sequelize seed:generate --name demo-user
# 运行种子文件插入数据
npx sequelize db:seed:all
```

- 编辑种子文件用于初始化数据

```js
'use strict';

module.exports = {
  up: (queryInterface, Sequelize) => {
    return queryInterface.bulkInsert('users', [
      { name: 'John1', age: 2 },
      { name: 'John2', age: 2 },
      { name: 'John3', age: 2 },
      { name: 'John4', age: 2 },
      { name: 'John5', age: 2 },
      { name: 'John6', age: 2 },
    ]);
  },

  down: (queryInterface, Sequelize) => {
    return queryInterface.bulkDelete('users', null, {});
  },
};
```

### app/model/ 目录下编写 Model 文件

- model 目录下创建的模型会自动挂载到 ctx.model 下
- app/model/user.js

```js
'use strict';

module.exports = app => {
  const { STRING, INTEGER, DATE } = app.Sequelize;

  const User = app.model.define(
    'users',
    {
      id: { type: INTEGER, primaryKey: true, autoIncrement: true },
      name: STRING(30),
      age: INTEGER,
      created_at: DATE,
      updated_at: DATE,
    },
    {
      charset: 'utf8mb4',
      collate: 'utf8mb4_bin',
    },
  );

  return User;
};
```

### extend/helper.js 文件夹下编辑拓展方法

- ctx.helper.parseInt(ctx.query.limit),

```js
'use strict';

module.exports = {
  parseInt(string) {
    if (typeof string === 'number') return string;
    if (!string) return string;
    return parseInt(string) || 0;
  },
};
```

### /controller/user.js 文件编写

> router.resources('users', '/users', controller.user);

- user.js - UserController - controller.user

```js
'use strict';

const Controller = require('egg').Controller;

class UserController extends Controller {
  async index() {
    const ctx = this.ctx;
    const query = {
      limit: ctx.helper.parseInt(ctx.query.limit),
      offset: ctx.helper.parseInt(ctx.query.offset),
    };
    ctx.body = await ctx.service.user.list(query);
  }

  async show() {
    const ctx = this.ctx;
    ctx.body = await ctx.service.user.find(ctx.helper.parseInt(ctx.params.id));
  }

  async create() {
    const ctx = this.ctx;
    const user = await ctx.service.user.create(ctx.request.body);
    ctx.status = 201;
    ctx.body = user;
  }

  async update() {
    const ctx = this.ctx;
    const id = ctx.helper.parseInt(ctx.params.id);
    const body = ctx.request.body;
    ctx.body = await ctx.service.user.update({ id, updates: body });
  }

  async destroy() {
    const ctx = this.ctx;
    const id = ctx.helper.parseInt(ctx.params.id);
    await ctx.service.user.del(id);
    ctx.status = 200;
  }
}

module.exports = UserController;
```

### /service/user.js 文件编写

- service 文件夹下的文件完成主要的业务逻辑
- user.js - User - await ctx.service.user.create(ctx.request.body);

```js
'use strict';

const Service = require('egg').Service;

class User extends Service {
  async list({ offset = 0, limit = 10 }) {
    return this.ctx.model.User.findAndCountAll({
      offset,
      limit,
      order: [['created_at', 'desc'], ['id', 'desc']],
    });
  }

  async find(id) {
    const user = await this.ctx.model.User.findById(id);
    if (!user) {
      this.ctx.throw(404, 'user not found');
    }
    return user;
  }

  async create(user) {
    return this.ctx.model.User.create(user);
  }

  async update({ id, updates }) {
    const user = await this.ctx.model.User.findById(id);
    if (!user) {
      this.ctx.throw(404, 'user not found');
    }
    return user.update(updates);
  }

  async del(id) {
    const user = await this.ctx.model.User.findById(id);
    if (!user) {
      this.ctx.throw(404, 'user not found');
    }
    return user.destroy();
  }
}

module.exports = User;
```

## view 模板插件添加( egg-view-nunjucks )

- 引入 view 插件

  > npm i egg-view-nunjucks --save

- config/plugin.js 文件中进行配置

```js
exports.nunjucks = {
  enable: true,
  package: 'egg-view-nunjucks',
};
```

- 模板文件的根目录，为绝对路径，默认为 \${baseDir}/app/view 可配置

```js
// config/config.default.js
const path = require('path');
module.exports = appInfo => {
  const config = {};
  config.view = {
    root: [path.join(appInfo.baseDir, 'app/view'), path.join(appInfo.baseDir, 'path/to/another')].join(','),
  };
  return config;
};
```

- 模板路径缓存，默认开启。
- 指定 .nj 后缀的文件使用 Nunjucks 进行渲染。
- 配置了 defaultExtension 渲染的时候可以省略后缀

```js
/** 模板文件配置  */
config.view = {
  root: [
    // 模板文件路径
    path.join(appInfo.baseDir, 'app/view'),
  ].join(','),
  defaultViewEngine: 'nunjucks', // 默认模板引擎
  defaultExtension: '.nj', // 渲染的时候可以省略后缀名
  mapping: {
    '.nj': 'nunjucks', // 根据后缀名匹配模板引擎
  },
};

// render app/view/home.nj
await ctx.render('home');
```

- render(name, locals) 渲染模板文件, 并赋值给 ctx.body
- renderView(name, locals) 渲染模板文件, 仅返回不赋值
- renderString(tpl, locals) 渲染模板字符串, 仅返回不赋值

## 静态资源的处理(egg-view-assets) 可以不用这一步默认框架已经处理

- 默认 public 下文件为静态文件
- 由内置插件约定的目录

```bash
app/public/** 用于放置静态资源，可选
app/schedule/** 用于定时任务
```

- 安装 egg-view-assets

  > cnpm i egg-view-assets -S

- 配置插件

```js
// config/plugin.js
exports.assets = {
  enable: true,
  package: 'egg-view-assets',
};
```

- 配置 assets 模板引擎

```js
// config/config.default.js
exports.view = {
  mapping: {
    '.js': 'assets',
  },
};
```

- 添加静态资源入口文件 app/view/index.js，然后调用 render 方法进行渲染

```js
// app/controller/home.js
module.exports = class HomeController extends Controller {
  async render() {
    await this.ctx.render('index.js');
  }
};
```

## 实现 RESTful API

- RESTful 接口规范

```bash
# 获取主题列表
GET /api/v2/topics
# 获取单个主题
GET /api/v2/topics/57ea257b3670ca3f44c5beb6
# 创建主题
POST /api/v2/topics
# 更新主题
PUT /api/v2/topics/57ea257b3670ca3f44c5beb6
```

- 安装验证插件

  > cnpm i -S egg-validate

- 开启验证插件

```js
/** 开启验证插件  */
exports.validate = {
  enable: true,
  package: 'egg-validate',
};
```

### 路由映射

- 通过 app.resources 方法，我们将 topics 这个资源的增删改查接口映射到了 app/controller/topics.js 文件。

```js
// app/router.js
module.exports = app => {
  app.router.resources('topics', '/api/v2/topics', app.controller.topics);
};
```

### controller 开发

- 实现 app.resources 约定的 RESTful 风格的 URL 定义
