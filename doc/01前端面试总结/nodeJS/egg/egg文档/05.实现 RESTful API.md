# 实现 RESTful API

## Restful API 有几个特性

```bash
面向资源：接口命名都是zoos、animals，而不是getAllAnimals这样的
使用Http动词：GET/PUT/POST/DELETE/PATCH/HEAD/OPTIONS，而不是我们日常只用的GET和POST
```

## egg 中 RESTful 风格的 URL 定义

- 快速在一个路径上生成 CRUD 路由结构。

  > app.resources('routerName', 'pathMatch', controller)

- 路由配置示例

```js
// app/router.js
module.exports = app => {
  const { router, controller } = app;
  router.resources('posts', '/api/posts', controller.posts);
  router.resources('users', '/api/v1/users', controller.v1.users); // app/controller/v1/users.js
};
```

- 上面代码就在 /posts 路径上部署了一组 CRUD 路径结构
- app/controller/posts.js 中实现对应的函数就可以了
- Method Path Route Name Controller.Action
- GET 获取
- POST 新增
- PUT 更新
- DELETE 删除

- 路由完整定义
  > router.verb('router-name', 'path-match', middleware1, ..., middlewareN, app.controller.action);

```js
/** GET	/posts	posts	 app.controllers.posts.index
 *  一般用于获取列表信息
 */
exports.index = async () => {};

/** GET	/posts/new	new_post	app.controllers.posts.new
 * 获取某些信息列表 比较少用
 */
exports.new = async () => {};

/** GET	/posts/:id	post	app.controllers.posts.show
 * 显示某一条记录信息
 */
exports.show = async () => {};

/** GET	/posts/:id/edit	edit_post	app.controllers.posts.edit
 * 编辑某条记录信息 比较少用
 */
exports.edit = async () => {};

/** POST	/posts	posts	app.controllers.posts.create
 * 新增一条记录
 */
exports.create = async () => {};

/** PUT	/posts/:id	post	app.controllers.posts.update
 * 更新某条记录信息
 */
exports.update = async () => {};

/** DELETE	/posts/:id	post	app.controllers.posts.destroy
 * 删除某条记录信息
 */
exports.destroy = async () => {};
```

## 路由参数获取

- 获取 url 上的参数 ctx.query.name

```js
// app/router.js
module.exports = app => {
  app.router.get('/search', app.controller.search.index);
};

// app/controller/search.js
exports.index = async ctx => {
  ctx.body = `search: ${ctx.query.name}`;
};

// curl http://127.0.0.1:7001/search?name=egg
```

- 参数命名方式

```js
// app/router.js
module.exports = app => {
  app.router.get('/user/:id/:name', app.controller.user.info);
};

// app/controller/user.js
exports.info = async ctx => {
  ctx.body = `user: ${ctx.params.id}, ${ctx.params.name}`;
};

// curl http://127.0.0.1:7001/user/123/xiaoming
```

- 路由里面也支持定义正则，可以更加灵活的获取参数：

```js
// app/router.js
module.exports = app => {
  app.router.get(
    /^\/package\/([\w-.]+\/[\w-.]+)$/,
    app.controller.package.detail
  );
};

// app/controller/package.js
exports.detail = async ctx => {
  // 如果请求 URL 被正则匹配， 可以按照捕获分组的顺序，从 ctx.params 中获取。
  // 按照下面的用户请求，`ctx.params[0]` 的 内容就是 `egg/1.0.0`
  ctx.body = `package:${ctx.params[0]}`;
};

// curl http://127.0.0.1:7001/package/egg/1.0.0
```

- 表单内容的获取

```js
// app/router.js
module.exports = app => {
  app.router.post('/form', app.controller.form.post);
};

// app/controller/form.js
exports.post = async ctx => {
  ctx.body = `body: ${JSON.stringify(ctx.request.body)}`;
};

// 模拟发起 post 请求。
// curl -X POST http://127.0.0.1:7001/form --data '{"name":"controller"}' --header 'Content-Type:application/json'
```

## 生成 CRUD 路由结构接口代码示例

## 问题

- 调用接口会报错 invalid csrf token

```js
// 解决方法一 config/config.default.js中
/** 禁用 csrf  */
config.security = {
  csrf: {
    enable: false
  }
};
```

sequelize 字段标题不能相同

单词

```pug
maturity 成熟度 到期
```
