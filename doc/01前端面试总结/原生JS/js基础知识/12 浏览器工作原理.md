# 浏览器工作原理

## 浏览器资源的加载顺序

- DOMContent​Loaded 事件

```js
/**
 * 当初始的 HTML 文档被完全加载和解析完成之后，DOMContentLoaded 事件被触发，而无需等待样式表、图像和子框架的完成加载。
 */

// 如果将link置于script之后，就会立即打印。
<link rel="stylesheet" href="css.php">
<script>
document.addEventListener('DOMContentLoaded',function(){
    console.log('3 seconds passed');
});
</script>
```

- 浏览器大致的解析渲染流程

```js
/**
 * 首先当用户输入一个URL的时候，浏览器就会发送一个请求，请求URL对应的资源,请求成功的话，浏览器会收到一个html文件。
 * HTML解析器会对这个文件自上而下开始解析，尝试去构建一棵完整的Dom树。

 * 在构建DOM树的时候，当遇到JS元素时
 * HTML解析器就会将控制权转让给JavaScript引擎线程，该线程会阻断HTML解析器的运行
 * 当js加载并且执行完毕后，JavaScript引擎线程会将控制权还给HTML解析器，让其去继续构建dom树
 * DOM的解析完成是依据是否遇到</html>标签

 * 当遇到css元素时
 * 浏览器会开 启一个异步请求线程，在该线程上，浏览器会去请求相应的css文件，运行CSS解析器构建cssom树(也叫css rule)
 * 该线程会阻塞 JavaScript引擎线程（即css后面的js模块的解析会在css解析完毕后执行）
 * 但是不会阻塞dom树的构建


 * render树
 * DOM树构建完之后，浏览器把DOM树中的一些不可视元素去掉，然后与CSSOM合成一棵render树。

 * layout树
 * 接着浏览器根据这棵render树，计算出各个节点(元素)在屏幕的位置。这个过程叫做layout，输出的是一棵layout树。
 * 最后浏览器根据这棵layout树，将页面渲染到屏幕上去。
 */
```

- 现代的浏览器都使用了猜测预加载

```js
/**
 * 当解析被阻塞的时候，浏览器会有一个轻量级的HTML（或CSS）扫描器（scanner）继续在文档中扫描
 * 查找那些将来可能能够用到的资源文件的url
 * 在渲染器使用它们之前将其下载下来，并且下载是可以并行进行的，并行的上限一般为6
 */
```

- 浏览器能够渲染不完整的 dom 树和 cssom，尽快的减少白屏的时间

```js
/**
 * 现代浏览器不会等到所有HTML解析之前开始构建和布局渲染树。
 * 浏览器能够渲染不完整的dom树和cssom，尽快的减少白屏的时间。

 * 当外联的JS代码和CSS代码还没从服务器传到浏览器的时候
 * 如果DOM树上有可视元素的话，浏览器通常会选择在这个时候，将一些内容提前渲染到屏幕上来。
 */
```

- 加快首屏渲染的最佳实践

```js
/**
 * css放在头部
 * 将css放在头部是为了减小浏览器的重绘成
 
 * 将js文件放在尾部
 * 确保能取到需要操作的dom对象
 * 缩短因为js的阻塞而造成的白屏时间，提升用户体验
 */
```

- 关于浏览器渲染

```js
/**
 * Reflow（回流）：
 * 浏览器要花时间去渲染，当它发现了某个部分发生了变化影响了布局，那就需要倒回去重新渲染。如更改字体大小

 * Repaint（重绘）：
 * 如果只是改变了某个元素的背景颜色，文字颜色等，不影响元素周围或内部布局的属性，将只会引起浏览器的repaint，重画某一部分。

 * Reflow要比Repaint更花费时间，也就更影响性能。
 */
```

- 关于 defer 和 async 的区别

```js
/**
 * defer 或 async 对应动态加载的script标签是无效的


 * 没有 defer 或 async，
 * 浏览器会立即加载并执行指定的脚本,也就是说不等待后续载入的文档元素，读到就加载并执行

 * defer
 * 有 defer，加载后续文档元素的过程将和 script.js 的加载并行进行不会阻塞后面DOM的加载
 * 但是 script.js 的执行要在所有元素解析完成之后
 * DOMContentLoaded 事件触发之前完成。
 * 其他defer引入的文件按照顺序执行

 * async
 * js文件在加载完成后马上执行，在其加载过程中后面的DOM可同步进行渲染
 * 不能保证其提async引入的js文件的执行顺序
 */
```

- 关于资源的加载

```js
/**
 * js
 * js的执行会阻塞DOM树的解析
 * 现代浏览器会并发的预加载CSS、JS、IMG
 * 当 HTML 解析器（HTML Parser）被脚本阻塞时，解析器虽然会停止构建 DOM，但仍会识别该脚本后面的资源，并进行预加载
 * js不会阻塞img的解码、paint

 * 渲染线程和js线程与资源进行加载的线程并不互斥，不会互斥意味着：
 * 资源的加载可以和UI渲染、重排，事件响应，或者JavaScript代码的执行的并发进行。

 
 * css
 * css文件是并行下载的
 * css的下载会阻塞后面js的执行
 * css的下载不会阻塞后面js的下载
 * css也会阻塞img解码、paint（浏览器认为你的CSS没有加载完毕，不确定图片的样式到底如何，牵扯到重绘资源问题
 */
```

## 参考资料

[浏览器工作原理详解](https://blog.csdn.net/u010794365/article/details/77982768)
[前端必读：浏览器内部工作原理](https://blog.csdn.net/findsafety/article/details/50424307)
[前端文摘：深入解析浏览器的幕后工作原理](http://www.cnblogs.com/lhb25/p/how-browsers-work.html)
