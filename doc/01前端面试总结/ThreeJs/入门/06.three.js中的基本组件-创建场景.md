## three.js 中的基本组件-创建场景

## 创建场景

```js
// 一个场景想要展示一些东西，必须包含以下要素

// 摄像机	决定屏幕上哪些东西需要渲染
// 光源	决定材质如何显示以及阴影
// 对象	它们是摄像机透视图里主要的渲染对象，例如：立方体、球体 等
// 渲染器	基于摄像机和场景提供的信息，调用底层API执行真正的场景绘制工作
```

## 场景的基本功能

```js
// 我们可以使用Three.Scence对象的scence.add(object)方法来添加一个Three.Mesh平面对象，一个Three.SpotLight聚光灯对象和一个环境光Three.AmbientLight对象。

// 定义一个场景
const scene = new THREE.Scene();

// 定义一个摄像机
const camera = new THREE.PerspectiveCamera(
  45,
  window.innerWidth / window.innerHeight,
  0.1,
  100
);
// 设置摄像机的位置
camera.position.set(-30, 40, 30);
// 摄像机指向场景中心
camera.lookAt(scene.position);
// 将摄像机添加到场景
scene.add(camera);

// 添加光源
// 聚光灯
const spotLight = new THREE.SpotLight(0xffffff, 1.2, 150, 120);
spotLight.position.set(-40, 60, -10);
spotLight.castShadow = true;
scene.add(spotLight);
// 环境光
const ambientLight = new THREE.AmbientLight(0x3c3c3c);
scene.add(ambientLight);

// 创建一个宽为60，高为40的的平面。
const planeGeometry = new THREE.PlaneGeometry(60, 40, 1, 1);
// 设置平面的材质
const planeMaterial = new THREE.MeshLambertMaterial({
  color: 0xffffff,
});
// 赋值到Mesh
const plane = new THREE.Mesh(planeGeometry, planeMaterial);
// 设置平面位置和旋转
plane.rotation.x = -0.5 * Math.PI;
plane.position.set(0, 0, 0);
// 设置地面为投影面
plane.receiveShadow = true;
// 将平面添加到场景中
scene.add(plane);
```

## 参数的调节及测试

```js
// 为了方便我们测试，我们再添加一个GUI组件，该组件包含了几个功能：添加方块、移除方块、场景要素个数统计，以及控制台打印各要素对象。

// 创建GUI控件，用于动态创建物体
// 保存希望被GUI改变的属性
let controls = {
  rotationSpeed: 0.02, // 旋转速度
  numberOfObjects: 0,
  addCube: () => {
    // 添加立方体
    const cubeSize = Math.ceil(Math.random() * 3);
    const cubeGeometry = new THREE.BoxGeometry(cubeSize, cubeSize, cubeSize);
    const cubeMaterial = new THREE.MeshLambertMaterial({
      color: Math.random() * 0xffffff,
    });
    const cube = new THREE.Mesh(cubeGeometry, cubeMaterial);
    cube.castShadow = true;
    cube.name = 'cube-' + scene.children.length;
    cube.position.x = Math.round(
      (Math.random() * planeGeometry.parameters.width) / 2
    );
    cube.position.y = Math.round(Math.random() * 5);
    cube.position.z = Math.round(
      (Math.random() * planeGeometry.parameters.height) / 2
    );
    scene.add(cube);
    // eslint-disable-next-line no-invalid-this
    controls.numberOfObjects = scene.children.length;
  },
  removeCube: () => {
    const allChildren = scene.children;
    const lastObject = allChildren[allChildren.length - 1];
    if (lastObject instanceof THREE.Mesh && lastObject !== plane) {
      scene.remove(lastObject);
      // eslint-disable-next-line no-invalid-this
      controls.numberOfObjects = scene.children.length;
    }
  },
  outputObjects: () => {
    console.log(scene.children);
  },
};
// 实例化GUI
const gui = new GUI();
gui.add(controls, 'rotationSpeed', 0, 0.5);
gui.add(controls, 'addCube');
gui.add(controls, 'removeCube');
gui.add(controls, 'numberOfObjects').listen();
gui.add(controls, 'outputObjects');
```

## 为场景添加雾化效果

```js
// 我们可以使用for属性为场景添加雾化效果，可以做出 场景中的物体距离摄像机越远越模糊。

// 为场景添加雾化效果
scene.fog = new THREE.FogExp2(0xffffff, 0.01); // 定义雾化颜色和浓度
```

## 总结

```js
// 目前为止，我们掌握了场景中的如下方法：
// THREE.Scene.add 向场景添加对象
// THREE.Scene.remove 移除场景中的指定对象
// THREE.Scene.children 获取场景中的所有子对象
// THREE.Scene.getObjectByName 通过name属性名称获取场景中的特定对象
// THREE.Scene.traverse 遍历场景中的对象，回调每一个对象
// THREE.Scene.fog 为场景添加雾化效果
```

## 完整代码

```js
/* eslint-disable radix */
// 导入 three.js 包
import * as THREE from 'three';
// 导入帧率统计包
import Stats from 'three/examples/js/libs/stats.min.js';
// 导入dat.gui
import { GUI } from '../libs/data.gui';
// 用于鼠标移动镜头
import { TrackballControls } from 'three/examples/jsm/controls/TrackballControls';
export default () => {
  // 帧率统计 0 fps 1 ms 2 mb 3 custom
  function initStats(type) {
    var panelType =
      typeof type !== 'undefined' && type && !isNaN(type) ? parseInt(type) : 0;
    var stats = new Stats();
    stats.showPanel(panelType);
    document.body.appendChild(stats.dom);
    return stats;
  }
  const stats = initStats();

  // 定义一个场景
  const scene = new THREE.Scene();
  // 为场景添加雾化效果
  scene.fog = new THREE.FogExp2(0xffffff, 0.01); // 定义雾化颜色和浓度

  // 定义一个摄像机
  const camera = new THREE.PerspectiveCamera(
    45,
    window.innerWidth / window.innerHeight,
    0.1,
    100
  );
  // 设置摄像机的位置
  camera.position.set(-30, 40, 30);
  // 摄像机指向场景中心
  camera.lookAt(scene.position);
  // 将摄像机添加到场景
  scene.add(camera);

  // 定义渲染器
  const renderer = new THREE.WebGLRenderer();
  // 定义场景的颜色为黑色
  renderer.setClearColor(0x000000);
  // 定义场景大小为整个窗口
  renderer.setSize(window.innerWidth, window.innerHeight);
  // 启动渲染阴影效果
  renderer.shadowMap.enabled = true;

  // 创建一个粗细为20的坐标轴
  const axes = new THREE.AxesHelper(20);
  scene.add(axes);

  // 添加光源
  // 聚光灯
  const spotLight = new THREE.SpotLight(0xffffff, 1.2, 150, 120);
  spotLight.position.set(-40, 60, -10);
  spotLight.castShadow = true;
  scene.add(spotLight);
  // 环境光
  const ambientLight = new THREE.AmbientLight(0x3c3c3c);
  scene.add(ambientLight);

  // 创建一个宽为60，高为40的的平面。
  const planeGeometry = new THREE.PlaneGeometry(60, 40, 1, 1);
  // 设置平面的材质
  const planeMaterial = new THREE.MeshLambertMaterial({
    color: 0xffffff,
  });
  // 赋值到Mesh
  const plane = new THREE.Mesh(planeGeometry, planeMaterial);
  // 设置平面位置和旋转
  plane.rotation.x = -0.5 * Math.PI;
  plane.position.set(0, 0, 0);
  // 设置地面为投影面
  plane.receiveShadow = true;
  // 将平面添加到场景中
  scene.add(plane);

  // 创建GUI控件，用于动态创建物体
  // 保存希望被GUI改变的属性
  let controls = {
    rotationSpeed: 0.02, // 旋转速度
    numberOfObjects: 0,
    addCube: () => {
      // 添加立方体
      const cubeSize = Math.ceil(Math.random() * 3);
      const cubeGeometry = new THREE.BoxGeometry(cubeSize, cubeSize, cubeSize);
      const cubeMaterial = new THREE.MeshLambertMaterial({
        color: Math.random() * 0xffffff,
      });
      const cube = new THREE.Mesh(cubeGeometry, cubeMaterial);
      cube.castShadow = true;
      cube.name = 'cube-' + scene.children.length;
      cube.position.x = Math.round(
        (Math.random() * planeGeometry.parameters.width) / 2
      );
      cube.position.y = Math.round(Math.random() * 5);
      cube.position.z = Math.round(
        (Math.random() * planeGeometry.parameters.height) / 2
      );
      scene.add(cube);
      // eslint-disable-next-line no-invalid-this
      controls.numberOfObjects = scene.children.length;
    },
    removeCube: () => {
      const allChildren = scene.children;
      const lastObject = allChildren[allChildren.length - 1];
      if (lastObject instanceof THREE.Mesh && lastObject !== plane) {
        scene.remove(lastObject);
        // eslint-disable-next-line no-invalid-this
        controls.numberOfObjects = scene.children.length;
      }
    },
    outputObjects: () => {
      console.log(scene.children);
    },
  };
  // 实例化GUI
  const gui = new GUI();
  gui.add(controls, 'rotationSpeed', 0, 0.5);
  gui.add(controls, 'addCube');
  gui.add(controls, 'removeCube');
  gui.add(controls, 'numberOfObjects').listen();
  gui.add(controls, 'outputObjects');

  // 将渲染的结果加入到div中
  document.querySelector('#webgl-box').appendChild(renderer.domElement);
  // 实现鼠标移动摄像头
  const trackballControls = new TrackballControls(camera, renderer.domElement);
  const clock = new THREE.Clock();

  // 渲染场景
  function render() {
    stats.update();
    trackballControls.update(clock);
    // 遍历场景中的所有子对象
    scene.traverse((obj) => {
      if (obj instanceof THREE.Mesh && obj !== plane) {
        obj.rotation.x += controls.rotationSpeed;
        obj.rotation.y += controls.rotationSpeed;
        obj.rotation.z += controls.rotationSpeed;
      }
    });
    requestAnimationFrame(render);
    renderer.render(scene, camera);
  }
  render();
};
```
