## Jest 测试 React 应用程序

```js
// 相关依赖的安装
// yarn add --dev jest babel-jest @babel/preset-env @babel/preset-react react-test-renderer

// babel.config.js
module.exports = {
  presets: ['@babel/preset-env', '@babel/preset-react'],
};

```

## 快照测试案例

```js
// Link.react.js
import React from 'react';
const STATUS = {
  HOVERED: 'hovered',
  NORMAL: 'normal',
};
export default class Link extends React.Component {
  constructor(props) {
    super(props);
    this._onMouseEnter = this._onMouseEnter.bind(this);
    this._onMouseLeave = this._onMouseLeave.bind(this);
    this.state = {
      class: STATUS.NORMAL,
    };
  }
  _onMouseEnter() {
    this.setState({class: STATUS.HOVERED});
  }
  _onMouseLeave() {
    this.setState({class: STATUS.NORMAL});
  }
  render() {
    return (
      <a
        className={this.state.class}
        href={this.props.page || '#'}
        onMouseEnter={this._onMouseEnter}
        onMouseLeave={this._onMouseLeave}
      >
        {this.props.children}
      </a>
    );
  }
}
```

```js
// 现在，使用React的test renderer和Jest的快照特性来和组件交互，获得渲染结果和生成快照文件：

// Link.react.test.js
import React from 'react';
import renderer from 'react-test-renderer';
import Link from '../Link.react';
test('Link changes the class when hovered', () => {
  const component = renderer.create(
    <Link page="http://www.facebook.com">Facebook</Link>,
  );
  let tree = component.toJSON();
  expect(tree).toMatchSnapshot();
  // manually trigger the callback
  tree.props.onMouseEnter();
  // re-rendering
  tree = component.toJSON();
  expect(tree).toMatchSnapshot();
  // manually trigger the callback
  tree.props.onMouseLeave();
  // re-rendering
  tree = component.toJSON();
  expect(tree).toMatchSnapshot();
});

// 当你运行 ​npm test​ 或者 ​jest
```


## 快照测试与 Mocks, Enzyme 和 React 16

```js
// DOM测试
// 如果你想断言和操作你的渲染组件，你可以使用react-testing-library、Enzyme或 React 的TestUtils。以下两个示例使用 react-testing-library 和 Enzyme。

// 反应测试库
// 你必须运行​yarn add --dev @testing-library/react​才能使用 react-testing-library。

// 让我们实现一个在两个标签之间交换的复选框：

// CheckboxWithLabel.js
import React from 'react';
export default class CheckboxWithLabel extends React.Component {
  constructor(props) {
    super(props);
    this.state = {isChecked: false};
    // bind manually because React class components don't auto-bind
    // https://reactjs.org/blog/2015/01/27/react-v0.13.0-beta-1.html#autobinding
    this.onChange = this.onChange.bind(this);
  }
  onChange() {
    this.setState({isChecked: !this.state.isChecked});
  }
  render() {
    return (
      <label>
        <input
          type="checkbox"
          checked={this.state.isChecked}
          onChange={this.onChange}
        />
        {this.state.isChecked ? this.props.labelOn : this.props.labelOff}
      </label>
    );
  }
}
```

```js
// __tests__/CheckboxWithLabel-test.js
import React from 'react';
import {cleanup, fireEvent, render} from '@testing-library/react';
import CheckboxWithLabel from '../CheckboxWithLabel';
// Note: running cleanup afterEach is done automatically for you in @testing-library/react@9.0.0 or higher
// unmount and cleanup DOM after the test is finished.
afterEach(cleanup);
it('CheckboxWithLabel changes the text after click', () => {
  const {queryByLabelText, getByLabelText} = render(
    <CheckboxWithLabel labelOn="On" labelOff="Off" />,
  );
  expect(queryByLabelText(/off/i)).toBeTruthy();
  fireEvent.click(getByLabelText(/off/i));
  expect(queryByLabelText(/on/i)).toBeTruthy();
});
```

## Enzyme

```js
// 你必须运行​yarn add --dev enzyme​才能使用 Enzyme。
// 如果你使用的是低于 15.5.0 的 React 版本，你还需要安装​react-addons-test-utils​.
// 让我们用Enzyme而不是反应测试库从上面重写测试。在这个例子中我们使用了 Enzyme 的浅渲染器。

// __tests__/CheckboxWithLabel-test.js
import React from 'react';
import {shallow} from 'enzyme';
import CheckboxWithLabel from '../CheckboxWithLabel';
test('CheckboxWithLabel changes the text after click', () => {
  // Render a checkbox with label in the document
  const checkbox = shallow(<CheckboxWithLabel labelOn="On" labelOff="Off" />);
  expect(checkbox.text()).toEqual('Off');
  checkbox.find('input').simulate('change');
  expect(checkbox.text()).toEqual('On');
});
```

## 自定义转译器

```js
// custom-transformer.js
'use strict';
const {transform} = require('@babel/core');
const jestPreset = require('babel-preset-jest');
module.exports = {
  process(src, filename) {
    const result = transform(src, {
      filename,
      presets: [jestPreset],
    });
    return result ? result.code : src;
  },
};

// 不要忘记安装@​babel/core​和​babel-preset-jest​包以使本示例正常工作
// 为了使这个与 Jest 一起工作，你需要更新你的 Jest 配置：​"transform": {"\\.js$": "path/to/custom-transformer.js"}​。
// 如果你想建立一个带 babel 支持的转译器，你还可以使用 babel-jest 组合一个并传递选项到你的自定义配置：

const babelJest = require('babel-jest');
module.exports = babelJest.createTransformer({
  presets: ['my-custom-preset'],
});
```